sudo: required
services:
  - docker
language: python
python:
  - '3.5'
cache:
  directories:
    - $HOME/docker
    - $HOME/postgresql
    - $HOME/.cache
env:
  global:
    - REGISTRY_USER=rapidproautomation
    # NOTE: this is generated with `travis encrypt REGISTRY_PASS="the-password"`
    #       which is decrypted by Travis CI and set as environment variables
    - secure: "ffYdrH1sxDNP+KrE3cnP2r5lYsRGOmPUwlBON60GsYKwMQDg8Of5vt9fK5FzW9p5SWTpcAhCHeuJjbQ8qB0i4Uh5HtAs2focQdH13CQSQ5RZroNP60gV4WQENmxHqCaLuMQ4zgLQjKdu2R1PkEaUwm/HdHOzQ1Gwt+QEivPgCxtxdvfMFoebffzunpISSoOxSA7DJLWfuWqhszOF2oa+KxrMp/DAVnjwKhyepqSbdxOfuYiKyEdmoiic8S4TLgeDcYSxJnZgGzDP8p3HRahGmXsosMeg2eNghohKZ+c2tiD7DBHbRIrikC1da6/XnsXpcz+ugHuMTw5QTvZcgqKfGkoOchg9/ae5vXWCNQL4b7CPPxgnuxO0jeNUgbeQLnbqrkyxgudCSrTRKlCdmE5G6QijzwyWYOy2BV7+8Ybs17EfqFtSnzn6J6D4+prbklQGy8zB3oyZZXPSPgTFdImyrYAL96Ag1jI6EbwfodzY7himEnquvmcpC9sDoEdX/Z9JWWRKAxqeADzDx/IXiVfT4M155Np8cq8pWFypKOy03DE8KsHnOwaPz0qxgl/imvXW198SUe9qmiavOCY0h+taHK50JK7mKzokCDI25OYbei91iW+0GSuQ4ZR78NeTDO4ktKDZkA9oYMHzi9oKoBCSe8SbZffkRGe6bK45MXvvfEo="

# Update Docker Engine
before_install:
  - sudo apt-get update
  - sudo apt-get install -qy -o Dpkg::Options::="--force-confold" docker-engine
  # Load cached docker images
  - if [[ -d $HOME/docker ]]; then ls $HOME/docker/*.tar.gz | xargs -I {file} sh -c "zcat {file} | docker load"; fi

install:
  - pip install docker-compose "click>=6.0,<=7.0"

before_cache:
  - docker save rapidpro/rapidpro-base | gzip -2 > $HOME/docker/rapidpro-base.tar.gz
  - docker save sdehaan/rapidpro | gzip -2 > $HOME/docker/rapidpro.tar.gz
  - docker-compose exec --user=postgres postgresql pg_dump rapidpro > $HOME/postgresql/rapidpro.sql

before_script:
  - image="sdehaan/rapidpro"
  - version="$(curl -s https://api.github.com/repos/nyaruka/rapidpro/tags  | jq -r .[].name | sort | tail -n1)"

script:
  - docker pull rapidpro/rapidpro-base
  - docker build --tag "$image" --build-arg RAPIDPRO_VERSION=$version .
  - docker-compose run -d postgresql
  - python wait-for.py --service=postgresql --find='PostgreSQL init process complete; ready for start up.' --verbose
  # Load the cached postgresql dump to speed up migrations
  - if [[ -d $HOME/postgresql/rapidpro.sql ]]; then cat $HOME/postgresql/rapidpro.sql | docker-compose exec --user=postgres postgresql psql rapidpro; fi
  - docker-compose run -d redis
  - python wait-for.py --service=redis --find='The server is now ready to accept connections on port 6379' --verbose
  - docker-compose run -d rapidpro
  - python wait-for.py --service=rapidpro --find="static files copied" --verbose
  # Massive timeout because massive migration history taking ages
  - python wait-for.py --service=rapidpro --find="Running migrations" --verbose --timeout=600
  - python wait-for.py --service=rapidpro --find="spawned uWSGI http 1" --verbose

after_script:
  - docker images

before_deploy:
  - docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
deploy:
  provider: script
  script: docker tag "$image":"$version" && docker push "$image":"$version"
  on:
    branch: develop
